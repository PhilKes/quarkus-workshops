[[ai]]
= Artificial Intelligence

'''

On one side we have superheroes, and on the other side we have super villains.
What happens when they fight?
Let's ask an AI to narrate the fight!

In this section we will introduce a new microservice that will use AI to narrate the fight between a superhero and a super villain.
It will use the Semantic Kernel API to generate the text invoking OpenAI or Azure OpenAI (you choose).

[plantuml,align=center,width=300]
----
include::{plantDir}/5b-ai-narration-microservice.puml[]
----

In the following sections, you will learn:

* What is Semantic Kernel?
* How to invoke OpenAI or Azure OpenAI GPT model using Semantic Kernel
* How to create an OpenAI Plugin (a.k.a Skill) to narrate a fight

IMPORTANT: This service is exposed on the port 8086.

== What's Semantic Kernel?

https://learn.microsoft.com/semantic-kernel/overview[Semantic Kernel] is an open-source SDK that lets you easily combine AI services like OpenAI, Azure OpenAI, and Hugging Face with conventional programming languages like C#, Python or Java.
By doing so, you can create AI apps that combine the best of both worlds:
the deterministic nature of conventional programming and the semantic aspect of AI.

image::semantic-kernel.png[Semantic Kernel]

Semantic Kernel has been engineered to allow developers to flexibly integrate AI services into their existing apps.
To do so, Semantic Kernel provides a set of connectors that make it easy to add memories and models.
In this way, Semantic Kernel is able to add a simulated "brain" to your app.

Additionally, Semantic Kernel makes it easy to add skills to your applications with AI plugins that allow you to interact with the real world.
These plugins are composed of prompts and native functions that can respond to triggers and perform actions.
In this way, plugins are like the "body" of your AI app.

== Narration Microservice

Let's create a new microservice that will use Semantic Kernel to narrate the fight between a superhero and a super villain.
New microservice, new project!

As before, the easiest way to create this new Quarkus project is to use the Quarkus Maven plugin (you can also go to https://code.quarkus.io if you prefer).
Open a terminal and run the following command:

[example, role="cta"]
--

[source,shell,subs="attributes+"]
----
cd quarkus-workshop-super-heroes/super-heroes

./mvnw io.quarkus:quarkus-maven-plugin:{quarkus-version}:create \
    -DplatformVersion={quarkus-version} \
    -DprojectGroupId=io.quarkus.workshop.super-heroes \
    -DprojectArtifactId=rest-narration \
    -DclassName="io.quarkus.workshop.superheroes.narration.NarrationResource" \
    -Dpath="api/narration" \
    -Dextensions="resteasy-reactive-jackson,quarkus-smallrye-openapi,quarkus-smallrye-fault-tolerance"
----
--

This microservice needs less dependencies than the previous ones:

* `resteasy-reactive-jackson` provides RESTEasy Reactive and the ability to map JSON objects,
* `quarkus-smallrye-openapi` provides the OpenAPI descriptor support and the Swagger UI in the dev console,
* `quarkus-smallrye-fault-tolerance` provides the MicroProfile Fault Tolerance dependency so we can fallback in case OpenAI/Azure OpenAI does not respond.

If you want your IDE to manage this new Maven project, you can declare it in the parent POM by adding this new module in the `<modules>` section:

[source,xml]
----
<module>super-heroes/rest-heroes</module>
----

=== Directory Structure

At the end of this chapter, you will end up with the following directory structure (notice the `NarrationSkill` directory under `src/main/resources`):

[plantuml]
----
@startsalt
{
{
T
super-heroes
+  rest-narration
++  src
+++  main
++++  docker
+++++  ...
++++  java
+++++  io
++++++  quarkus
+++++++  workshop
++++++++  superheroes
+++++++++  narration
++++++++++  Fight.java
++++++++++  NarrationResource.java
++++++++++  NarrationService.java
++++++++++  SemanticKernelNarrationService.java
++++  resources
+++++  NarrationSkill
+++++++  NarrateFight
+++++++++  config.json
+++++++++  skprompt.txt
+++++  META-INF
++++++  resources
+++++++  index.html
+++++  application.properties
+++  test
++++  java
+++++  io
++++++  quarkus
+++++++  workshop
++++++++  superheroes
+++++++++  narration
++++++++++  NarrationResourceTest.java
++++++++++  NarrationResourceIT.java
++  mvnw
++  mvnw.cmd
++  pom.xml
}
}
@endsalt
----

=== Add the Semantic Kernel dependencies

Once the project is created, you need to add the Semantic Kernel dependencies.
Semantic Kernel is available on https://central.sonatype.com/artifact/com.microsoft.semantic-kernel/semantickernel-bom[Maven Central].
It has a BOM (Bill of Materials) that you can import in your project and then add the dependencies you need.
Add the following XML in the `rest-narration/pom.xml` file:

[source,xml,subs="attributes+"]
----
  <properties>
    <!-- ... -->
    <semantic-kernel.version>{semantic-kernel-version}</semantic-kernel.version>
  </properties>
  <dependencyManagement>
    <dependencies>
      <!-- ... -->
      <dependency>
        <groupId>com.microsoft.semantic-kernel</groupId>
        <artifactId>semantickernel-bom</artifactId>
        <version>${semantic-kernel.version}</version>
        <type>pom</type>
        <scope>import</scope>
      </dependency>
    </dependencies>
  </dependencyManagement>
  <dependencies>
    <!-- ... -->
    <dependency>
      <groupId>com.microsoft.semantic-kernel</groupId>
      <artifactId>semantickernel-core</artifactId>
    </dependency>
    <dependency>
      <groupId>com.microsoft.semantic-kernel</groupId>
      <artifactId>semantickernel-connectors-ai-openai</artifactId>
    </dependency>
  </dependencies>
----

=== The Fight bean

Let's start with the `Fight` class.
The fight is what is going to be narrated by the microservice and ultimately sent by the Fight microservice.

[example, role="cta"]
--

Create the `io.quarkus.workshop.superheroes.narration.Fight` class in the created project with the following content:

[source,java]
----
include::../../../../../super-heroes/rest-narration/src/main/java/io/quarkus/workshop/superheroes/narration/Fight.java[]
----
--

=== The Narration Resource

Unlike the `VillainResource`, the `HeroResource` uses the reactive development model.
It returns asynchronous structures (`Uni`)footnote:[There is another structure `Multi` to represent asynchronous streams of items. We will see `Multi` examples later].

[example, role="cta"]
--
Open the generated `io.quarkus.workshop.superheroes.narration.NarrationResource` and update the content to be:

[source,java]
----
include::../../../../../super-heroes/rest-narration/src/main/java/io/quarkus/workshop/superheroes/narration/NarrationResource.java[]
----
--

== Semantic Kernel

=== Semantic Kernel API in 2 minutes

=== The Semantic Kernel Narration service

[example, role="cta"]
--
Open the `NarrationResource` and update the content to be:

[source,java]
----
include::../../../../../super-heroes/rest-narration/src/main/java/io/quarkus/workshop/superheroes/narration/NarrationService.java[]
----

[source,java]
----
include::../../../../../super-heroes/rest-narration/src/main/java/io/quarkus/workshop/superheroes/narration/SemanticKernelNarrationService.java[]
----
--

==== The Semantic Kernel Narration plugin (a.k.a. skill)


[example, role="cta"]
--
Open the `NarrationResource` and update the content to be:

[source,text]
----
include::../../../../../super-heroes/rest-narration/src/main/resources/NarrationSkill/NarrateFight/skprompt.txt[]
----

[source,json]
----
include::../../../../../super-heroes/rest-narration/src/main/resources/NarrationSkill/NarrateFight/config.json[]
----
--

=== Configuring the access to OpenAI/Azure OpenAI

Configuring the reactive access to the database is relatively similar to configuring the JDBC url.

[example, role="cta"]
--
Create the `resources/conf.properties` file and add:

[source,properties]
----
client.azureopenai.key=
client.azureopenai.endpoint=
client.azureopenai.deploymentname=
----

We also set the port to be 8086 by adding the following configuration to the `application.properties` file:

[source,properties]
----
## HTTP configuration
quarkus.http.port=8086
----
--


== Testing the Narration Microservice

Time for some tests!
Open the `io.quarkus.workshop.superheroes.narration.NarrationResourceTest` class and copy the following content:

[example, role="cta"]
--

[source,java]
----
include::../../../../../super-heroes/rest-narration/src/test/java/io/quarkus/workshop/superheroes/narration/NarrationResourceTest.java[]
----
--

[example, role="cta"]
--
Make sure the tests pass by executing the command `./mvnw test` (or from your IDE).
--

== Running the Narration Microservice

Now that the tests are green, we are ready to run our Narration microservice.

[example, role="cta"]
--

Use `./mvnw quarkus:dev` to start it.
Once the application is started, create a new narration with the following cUrl command:

[source,shell]
----
curl -X POST -d  '{"winnerName":"Super winner", "winnerLevel":42, "winnerPowers":"jumping", "loserName":"Super loser", "loserLevel":2, "loserPowers":"leaping", "winnerTeam":"heroes", "loserTeam":"villains" }'  -H "Content-Type: application/json" http://localhost:8086/api/narration -v

< HTTP/1.1 201 Created
< Content-Type: text/plain;charset=UTF-8

The battle between the towering Chewbacca and the dark and menacing Darth Vader was one for the ages. Chewbacca's incredible strength and agility were no match for Vader's mastery of the Force and his arsenal of weapons. The two clashed in a flurry of blows and energy blasts, each trying to gain the upper hand.

Despite Chewbacca's valiant efforts, it was clear that Vader was the superior fighter. His precognition and danger sense allowed him to anticipate every move Chewbacca made, and his energy blasts and electrokinesis were devastating. In the end, Vader emerged victorious, leaving Chewbacca battered and defeated.
----
--

The cUrl command returns the location of the newly created hero.
Take this URL and do an HTTP GET on it.

[NOTE]
====
The example shows a newly created Hero with id `952`.
But this id could be different on your machine.
Just make sure to use the correct id in the next command.
====

[source,shell]
----
curl http://localhost:8083/api/heroes/952 | jq

{
  "id": 952,
  "name": "Super level",
  "otherName": null,
  "level": 2,
  "picture": null,
  "powers": "leaping"
}
----

Remember that you can also check Swagger UI by going to the dev console: http://localhost:8083/q/dev.

[example, role="cta"]
--

Then, build the application using: `./mvnw package`, and run the application using `java -jar target/quarkus-app/quarkus-run.jar`.
Open your browser and go to http://localhost:8083/api/heroes.
--

== Invoking the Narration Microservice from the Fight Microservice

Now that we have a narration microservice up and running, we can invoke it from the fight microservice.

[plantuml,align=center,width=300]
----
include::{plantDir}/5a-ai-physical-architecture.puml[]
----

[example, role="cta"]
--

Go back to the `io.quarkus.workshop.superheroes.fight.FightResource` class and add the new `narrateFight` method:
/Users/agoncal/Documents/Code/Agoncal/quarkus-workshops/quarkus-workshop-super-heroes/
[source,java,indent=0]
----
include::../../../../../super-heroes/rest-fights/src/main/java/io/quarkus/workshop/superheroes/fight/FightResource.java[tag=adocNarrate]
----

The `FightResource` invokes a new method of the `FightService`.
Add the following method to the `io.quarkus.workshop.superheroes.fight.FightService` class and make sure to inject the `NarrationProxy`:

[source,java]
----
include::../../../../../super-heroes/rest-fights/src/main/java/io/quarkus/workshop/superheroes/fight/FightService.java[tag=adocNarrate]
----



[source,java]
----
include::../../../../../super-heroes/rest-fights/src/main/java/io/quarkus/workshop/superheroes/fight/client/NarrationProxy.java[]
----

To link both microservices, we need to add the following configuration to the `rest-fights/src/main/resources/application.properties` file of the fight microservice:

[source,properties]
----
include::../../../../../super-heroes/rest-fights/src/main/resources/application.properties[tag=adocNarrate]
----
--

=== Test and mock the Narration microservice invocation

Like the other dependencies, the Narration microservice needs to be mocked so we can test the Fight microservice in isolation.


[example, role="cta"]
--

Add the following `shouldNarrate` test to the `io.quarkus.workshop.superheroes.fight.FightResourceTest` class:

[source,java,indent=0]
----
include::../../../../../super-heroes/rest-fights/src/test/java/io/quarkus/workshop/superheroes/fight/FightResourceTest.java[tag=adocNarrate]
----

Create the `io.quarkus.workshop.superheroes.fight.client.MockNarrationProxy` class and add the new `narrateFight` method:

[source,java]
----
include::../../../../../super-heroes/rest-fights/src/test/java/io/quarkus/workshop/superheroes/fight/client/MockNarrationProxy.java[]
----
--

== Running, Testing and Packaging the Application

image::angular-ui.png[role=half-size]
